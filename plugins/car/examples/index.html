<!doctype html><title>Minimal tQuery Page</title>
<script src="../../../build/tquery-bundle.js"></script>
<script src="../../requirejs/tquery.norequirejs.js"></script>

<script src="../../../vendor/threex/THREEx.KeyboardState.js"></script>
<script src="../../keyboard/tquery.keyboard.js"></script>

<script src='../../checkerboard/tquery.checkerboard.js'></script>
<script src='../../fog/tquery.world.createfog.js'></script>

<script src="../Car.js"></script>
<script src="../tquery.car.js"></script>
<script src="../tquery.car.keyboard.js"></script>
<body><script>
	var world	= tQuery.createWorld().boilerplate().start();

	world.removeCameraControls();
	world.camera().position.set(500,100,300)
	world.camera().position.set(5,0.5,3)
	world.camera().lookAt(new THREE.Vector3(0,0,0))

	//world.camera().position.set(10,0,0).normalize().multiplyScalar(2);
	//world.camera().lookAt(new THREE.Vector3(0,0,0))

	world.renderer().setClearColorHex( 0x000000, world.renderer().getClearAlpha() );
	
	world.addFogExp2({density : 0.05});
	
	tQuery.createAmbientLight().addTo(world).color(0xFFFFFF);
	tQuery.createDirectionalLight().addTo(world).position(-1,1,1).color(0xffffff).intensity(2);
	tQuery.createDirectionalLight().addTo(world).position( 1,1,-1).color(0xffffff).intensity(2);
	
	//tQuery.createSpotLight().addTo(world).position( 1,1,-1).color(0x4444FF).intensity(2);

//	var tLight	= new THREE.SpotLight(0x8888ff);
////	tLight.position.set(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize();
//	tLight.position.set(0,1,0);
//	tLight.target.position.set( 0, 0, 0 );
//	tLight.intensity	= 2;
//	world.scene().add(tLight)


	tQuery.createCheckerboard({
		segmentsW	: 100,	// number of segment in width
		segmentsH	: 100,	// number of segment in Height
		//materialEven	: new THREE.MeshPhongMaterial({
		//	ambient	: 0x888888,
		//	color	: 0xcccccc,
		//	specular: 0xff00ff,
		//	shininess: 5
		//}),
		//materialOdd	: new THREE.MeshPhongMaterial({
		//	ambient	: 0x111111,
		//	color	: 0x444444,
		//	specular: 0xff00ff,
		//	shininess: 5
		//})
	}).addTo(world).scaleBy(100);

	//var car	= tQuery.createCar().hookKeyboard();


	var car	= tQuery.createCar({
		type	: "veyron",
		scale	: 1.5/400
	}).hookKeyboard();
	
	// attempts at camera control
	var curAngle	= 0;
	var curDistance	= 0;
	var spdDistance	= 0.95;
	var maxAngle	= Math.PI/8;
	var spdAngle	= 0.8;
	var prevPosition= null;
	world.loop().hook(function(){
		var tObject3d	= car.object3d();

		var carAngle	= car._car.carOrientation;
		curAngle	= spdAngle*curAngle + (1-spdAngle)*carAngle;
		curAngle	= Math.max(curAngle, carAngle - maxAngle);
		curAngle	= Math.min(curAngle, carAngle + maxAngle);

		var distance	= -1;
		if( prevPosition ){
			var delta	= tObject3d.position.clone().subSelf(prevPosition);
			var speed	= delta.length();
			console.log("len", speed)
			speed	= Math.max(speed, 0);
			speed	= Math.min(speed, 0.15);
			distance	= -1-(speed / 0.15)*2.5;
			
			curDistance	= spdDistance*curDistance + (1-spdDistance)*distance;			
		}
		prevPosition	= tObject3d.position.clone();

		var offset	= new THREE.Vector3(0, 0.5, curDistance);
		var matrix	= new THREE.Matrix4().setRotationY(curAngle);
		matrix.multiplyVector3(offset).addSelf(tObject3d.position);
		world.camera().position.copy(offset);
		
		var offset	= new THREE.Vector3(0, 0, -curDistance);
		var matrix	= new THREE.Matrix4().setRotationY(curAngle);
		matrix.multiplyVector3(offset).addSelf(tObject3d.position);
		world.camera().lookAt(offset);
	});
	
	if( false ){
		var car	= new tQuery.Car({
			type	: "gallardo"
		});
		car.hookKeyboard({
			keyStateRight	: "d",
			keyStateUp	: "z",
			keyStateLeft	: "q",
			keyStateDown	: "s"
		});		
	}

</script></body>